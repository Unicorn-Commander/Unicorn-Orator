version: '3.8'

services:
  # --- Speech-to-Text Service: WhisperX ---
  whisperx:
    build: ./whisperx
    container_name: orator-whisperx
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      WHISPER_MODEL: "${WHISPER_MODEL:-base}"
      DEVICE: "${WHISPERX_DEVICE:-cpu}"
      COMPUTE_TYPE: "${WHISPERX_COMPUTE_TYPE:-int8}"
      BATCH_SIZE: "${WHISPERX_BATCH_SIZE:-16}"
      HF_TOKEN: "${HF_TOKEN:-}"
    volumes:
      - whisperx_models:/app/models
    networks:
      orator-network:
        aliases:
          - whisperx
          - stt
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 300s  # 5 minutes for model download

  # --- Text-to-Speech Service: Kokoro (Intel iGPU via OpenVINO) ---
  kokoro-tts:
    build: ./kokoro-tts
    container_name: orator-kokoro
    restart: unless-stopped
    ports:
      - "8880:8880"
    environment:
      DEVICE: "${KOKORO_DEVICE:-CPU}"  # CPU, IGPU, or CUDA
      DEFAULT_VOICE: "${KOKORO_VOICE:-af}"
    devices:
      - /dev/dri:/dev/dri  # For Intel iGPU support
    group_add:
      - "44"    # video group
      - "993"   # render group (may vary by system)
    volumes:
      - kokoro_models:/app/models
    networks:
      orator-network:
        aliases:
          - kokoro
          - tts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8880/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # --- Nginx Reverse Proxy (optional) ---
  nginx:
    image: nginx:alpine
    container_name: orator-nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - orator-network
    depends_on:
      - whisperx
      - kokoro-tts

networks:
  orator-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

volumes:
  whisperx_models:
  kokoro_models: